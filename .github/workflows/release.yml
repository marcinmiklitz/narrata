name: release

on:
  push:
    tags:
      - "v*"

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  verify:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: "3.11"
            pandas-track: "latest"
          - python-version: "3.13"
            pandas-track: "latest"
          - python-version: "3.14"
            pandas-track: "latest"
          - python-version: "3.12"
            pandas-track: "2"
          - python-version: "3.12"
            pandas-track: "3"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Ensure tagged commit is on main
        run: |
          git fetch origin main --depth=1
          if ! git branch -r --contains "$GITHUB_SHA" | grep -q "origin/main"; then
            echo "Tagged commit is not on main."
            exit 1
          fi
      - name: Validate tag version matches package versions
        run: |
          python - <<'PY'
          import re
          from pathlib import Path

          import os

          tag = os.environ.get("GITHUB_REF_NAME", "")
          if not tag.startswith("v"):
              raise SystemExit(f"Expected v-prefixed tag, got: {tag}")
          expected = tag[1:]

          if not re.fullmatch(r"\d+\.\d+\.\d+(?:[a-zA-Z0-9\.\-\+]*)?", expected):
              raise SystemExit(f"Invalid release version from tag: {expected}")

          for path in [Path("src/narrata/pyproject.toml"), Path("src/narrata-mcp/pyproject.toml")]:
              content = path.read_text()
              match = re.search(r'(?m)^version\s*=\s*"([^"]+)"', content)
              if not match:
                  raise SystemExit(f"Version field not found in {path}")
              actual = match.group(1)
              if actual != expected:
                  raise SystemExit(f"{path} version mismatch: expected {expected}, found {actual}")
              print(f"OK {path}: {actual}")
          PY
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: Recreate venv from scratch
        run: rm -rf .venv
      - name: Sync workspace projects
        run: make sync
      - name: Pin pandas 2.x
        if: matrix.pandas-track == '2'
        run: uv pip install --python .venv/bin/python "pandas>=2,<3"
      - name: Pin pandas 3.x
        if: matrix.pandas-track == '3'
        run: uv pip install --python .venv/bin/python "pandas>=3,<4"
      - name: Run checks
        run: make check
      - name: Run tests
        run: make test
      - name: Run MCP tests explicitly
        run: uv run pytest src/narrata-mcp/tests/test_server.py

  build-narrata:
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: Recreate venv from scratch
        run: rm -rf .venv
      - name: Sync dependencies
        run: make sync
      - name: Build narrata distribution
        run: uv build --project src/narrata --out-dir dist
      - name: Upload narrata dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-narrata
          path: dist/*

  build-mcp:
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: Recreate venv from scratch
        run: rm -rf .venv
      - name: Sync dependencies
        run: make sync
      - name: Build narrata-mcp distribution
        run: uv build --project src/narrata-mcp --out-dir dist
      - name: Upload narrata-mcp dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-narrata-mcp
          path: dist/*

  publish-narrata:
    needs: build-narrata
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Download narrata dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-narrata
          path: dist
      - name: Publish narrata to PyPI (Trusted Publishing)
        uses: pypa/gh-action-pypi-publish@release/v1

  publish-mcp:
    needs: [build-mcp, publish-narrata]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Download narrata-mcp dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-narrata-mcp
          path: dist
      - name: Publish narrata-mcp to PyPI (Trusted Publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
